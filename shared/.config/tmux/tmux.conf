# Tmux Configuration - Replicating WezTerm Setup
# Modern tmux configuration with WezTerm-style bindings

# =====================================
# CORE SETTINGS
# =====================================

# Set prefix to C-x (like WezTerm leader)
set -g prefix C-x
unbind C-b
bind C-x send-prefix

# Enable mouse support
set -g mouse on

# Set default terminal and enable RGB colors
set -g default-terminal "tmux-256color"
set-option -sa terminal-overrides ",xterm*:Tc"
set -ga terminal-overrides ",*256col*:Tc"
set -ga terminal-overrides ",xterm-ghostty:Tc"

# Faster escape sequences (reduce escape-time from default)
set -sg escape-time 10

# Start windows and panes at 1, not 0
set -g base-index 1
set -g pane-base-index 1
set-window-option -g pane-base-index 1

# Don't exit from tmux when closing a session
set -g detach-on-destroy off

# Renumber all windows when any window is closed
set -g renumber-windows on

# Use current path for new windows and panes
bind c new-window -c "#{pane_current_path}"

# No bells
set -g bell-action none

# Enable vi mode for copy mode
set -g mode-keys vi

# Allow tmux to passthrough OSC sequences
set -g allow-passthrough on

# Reload configuration file
bind r source-file ~/.config/tmux/tmux.conf \; display-message "Config reloaded!"

# =====================================
# PANE NAVIGATION (replicating WezTerm)
# =====================================

# Pane navigation handled by tmux-navigator plugin
# See plugin configuration below

# Pane navigation with Leader+hjkl (always works)
bind h select-pane -L
bind j select-pane -D
bind k select-pane -U
bind l select-pane -R

# Pane resizing with Leader+HJKL
bind -r H resize-pane -L 5
bind -r J resize-pane -D 5
bind -r K resize-pane -U 5
bind -r L resize-pane -R 5

# Arrow key pane resizing (like WezTerm)
bind -r Left resize-pane -L 5
bind -r Down resize-pane -D 5
bind -r Up resize-pane -U 5
bind -r Right resize-pane -R 5

# =====================================
# WINDOW/PANE SPLITS
# =====================================

# Horizontal split (like Super+d in WezTerm)
bind | split-window -h -c "#{pane_current_path}"

# Vertical split (like Super+Shift+d in WezTerm) 
bind - split-window -v -c "#{pane_current_path}"
bind _ split-window -v -c "#{pane_current_path}"

# Keep the old bindings too
bind v split-window -h -c "#{pane_current_path}"

# =====================================
# SESSION MANAGEMENT & SESSIONIZER
# =====================================

# Session switching (Leader+w)
bind w choose-tree -Zs

# Sessionizer script (replicating WezTerm's sessionizer - Leader+f)
bind-key -r f run-shell "tmux neww ~/.config/tmux/scripts/sessionizer.sh"

# Quick session creation
bind S command-prompt -p "New Session:" "new-session -A -s '%%'"

# =====================================
# WINDOW MANAGEMENT
# =====================================

unbind -n 'M-{'
unbind -n 'M-}'

bind -n 'M-{' previous-window
bind -n 'M-}' next-window

bind -r "<" swap-window -d -t -1
bind -r ">" swap-window -d -t +1

# Kill pane/window without confirmation
bind x kill-pane
bind X kill-window

# Balance pane sizes
bind = select-layout -E

# =====================================
# COPY MODE (replicating WezTerm)
# =====================================

# Enter copy mode (Leader+y like WezTerm)
bind y copy-mode

# Copy mode vi bindings
bind-key -T copy-mode-vi v send-keys -X begin-selection
bind-key -T copy-mode-vi C-v send-keys -X rectangle-toggle

# Cross-platform clipboard support
# macOS: pbcopy, Linux: wl-copy (Wayland) or xclip (X11)
if-shell 'command -v pbcopy' {
    bind-key -T copy-mode-vi y send-keys -X copy-pipe-and-cancel "pbcopy"
    bind-key -T copy-mode-vi MouseDragEnd1Pane send-keys -X copy-pipe-and-cancel "pbcopy"
} {
    if-shell 'command -v wl-copy' {
        bind-key -T copy-mode-vi y send-keys -X copy-pipe-and-cancel "wl-copy"
        bind-key -T copy-mode-vi MouseDragEnd1Pane send-keys -X copy-pipe-and-cancel "wl-copy"
    } {
        if-shell 'command -v xclip' {
            bind-key -T copy-mode-vi y send-keys -X copy-pipe-and-cancel "xclip -selection clipboard"
            bind-key -T copy-mode-vi MouseDragEnd1Pane send-keys -X copy-pipe-and-cancel "xclip -selection clipboard"
        }
    }
}

# Paste buffer
bind P paste-buffer

# =====================================
# OTHER UTILITIES
# =====================================

# Toggle pane zoom (like WezTerm Leader+Return)
bind Enter resize-pane -Z

# Quick select (similar to WezTerm Leader+Space)
# bind Space copy-mode \; send-keys -X begin-selection

# Toggle synchronize panes
bind Y set synchronize-panes\; display 'synchronize-panes #{?synchronize-panes,on,off}'

# Toggle monitoring activity
bind M set monitor-activity

# Window size toggle
# bind F set -w window-size

# set -g @tmux-fzf-launch-key '/'

# =====================================
# STATUS BAR CONFIGURATION
# =====================================

# Status bar on top (more like WezTerm tabs)
set -g status-position top

# Status bar colors (Tomorrow Night theme to match WezTerm)
set -g status-bg "#1d1f21"
set -g status-fg "#c5c8c6"

# Left status: session@host (like WezTerm workspace)
set -g status-left-length 40
set -g status-left "#[fg=#81a2be,bold] #S@#H "

# Right status: empty (like WezTerm)
set -g status-right ""

# Window status format (like WezTerm tab format)
# Shows window index:name then each pane as *1:zsh 2:vim (* marks active pane)
set -g window-status-format " #I:#W #(~/.config/tmux/scripts/pane-status.sh #S:#I)"
set -g window-status-current-format "#[fg=#1d1f21,bg=#81a2be,bold] #I:#W #(~/.config/tmux/scripts/pane-status.sh #S:#I)"

# Pane border colors
set -g pane-border-style "fg=#373b41"
set -g pane-active-border-style "fg=#81a2be"

# Message style
set -g message-style "bg=#81a2be,fg=#1d1f21"

# =====================================
# PLUGINS
# =====================================

# TPM plugin manager
set -g @plugin "tmux-plugins/tpm"
set -g @plugin "tmux-plugins/tmux-sensible"
set -g @plugin "sainnhe/tmux-fzf"
set -g @plugin "Morantron/tmux-fingers"

set -g @fingers-key Space

# Manual vim-tmux navigation (without C-\)
is_vim="ps -o comm= -t #{s|/dev/||:pane_tty} | grep -q vim"
bind-key -n 'C-h' if-shell "$is_vim" 'send-keys C-h' 'select-pane -L'
bind-key -n 'C-j' if-shell "$is_vim" 'send-keys C-j' 'select-pane -D'
bind-key -n 'C-k' if-shell "$is_vim" 'send-keys C-k' 'select-pane -U'
bind-key -n 'C-l' if-shell "$is_vim" 'send-keys C-l' 'select-pane -R'

# =====================================
# ADDITIONAL MODERN TMUX FEATURES
# =====================================

# Enable focus events
set -g focus-events on

# Extended keys support for better key handling (tmux 3.2+)
# Disabled: causes escape sequences in neovim paste over SSH
# set -g extended-keys on
# set -as terminal-features 'xterm*:extkeys'

# Increase scrollback buffer
set -g history-limit 50000

# Display time for status messages
set -g display-time 4000

# Refresh status often (for pane info updates)
set -g status-interval 2

# Enable aggressive resize for better multi-monitor support
set -g aggressive-resize on

# Initialize TPM (keep this at the very bottom)
run "~/.config/tmux/plugins/tpm/tpm"
