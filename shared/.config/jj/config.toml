"$schema" = "https://jj-vcs.github.io/jj/latest/config-schema.json"

[user]
name = "Laurynas Keturakis"
email = "laurynas.keturakis@gmail.com"

[ui]
default-command = "overview"
editor = "nvim"
#pager = "delta"
diff-formatter = "difft"

[merge-tools.difft]
program = "difft"
diff-args = [
	"--display",
	"side-by-side",
	"--color",
	"always",
	"$left",
	"$right",
]

[aliases]
overview = [
	"util",
	"exec",
	"--",
	"sh",
	"-c",
	"jj diff --stat && jj log --limit 3",
]
l = ["log", "-r", "all()", "--color=always", "-n", "15"]
n = ["new"]
# tug = ["bookmark", "move", "--from", "closest_bookmark(@-)", "--to", "@-"]
tug = ["util", "exec", "--", "sh", "-c", """
if [ "x$1" = "x" ]; then
  jj bookmark move --from "closest_bookmark(@)" --to "closest_pushable(@)"
else
  jj bookmark move --to "closest_pushable(@)" "$@"
fi
""", ""]
pull = ["git", "fetch"]
push = [
	"util",
	"exec",
	"--",
	"sh",
	"-c",
	"""
# Prefer pushing the closest bookmark (e.g. main) if it exists
bookmark=$(jj log -r 'closest_bookmark(@)' -T 'bookmarks' --no-graph 2>/dev/null | head -1 | cut -d ' ' -f 1)
if [ -n "$bookmark" ]; then
  jj git push -b "$bookmark"
  exit $?
fi

# Fallback: use closest_pushable to find the right commit (skips empty/no-description)
target=$(jj log -r 'closest_pushable(@)' -T 'change_id' --no-graph 2>/dev/null | head -1)
if [ -n "$target" ]; then
  jj git push -c "$target"
else
  echo "No pushable commit found (need non-empty commit with description)"
  exit 1
fi
""",
]
pushall = [
	"util",
	"exec",
	"--",
	"sh",
	"-c",
	"jj git remote list | awk '{print $1}' | xargs -I {} sh -c 'echo Pushing to {}... && jj git push --remote {}'",
]
pr = [
	"util",
	"exec",
	"--",
	"bash",
	"-c",
	"""
gh pr create --head $(jj log -r 'closest_bookmark(@)' -T 'bookmarks' --no-graph | cut -d ' ' -f 1)
""",
]
aipr = [
	"util",
	"exec",
	"--",
	"bash",
	"-c",
	"""
set -e

# Get the bookmark name
bookmark=$(jj log -r 'closest_bookmark(@)' -T 'bookmarks' --no-graph | cut -d ' ' -f 1)
if [ -z "$bookmark" ]; then
  echo "Error: No bookmark found. Run 'jj push' first to create one."
  exit 1
fi

# Get commits in the stack
commits=$(jj log -r "::@ & ~::main" -T 'change_id.short() ++ " " ++ description.first_line() ++ "\n"' --no-graph)

# Get the diff
diff=$(jj diff -r 'main..@' --stat)

# Generate PR description using claude
description=$(claude -p "You are a PR description writer. Write a concise, technical PR description.

Keep the language technical and straightforward, avoiding unnecessary adjectives.

Format:
## Summary
<1-2 sentence summary>

## Changes
<bullet points of key changes>

---

Commits:
$commits

Changes:
$diff" 2>/dev/null)

# Check if PR already exists
if gh pr view "$bookmark" &>/dev/null; then
  echo "Updating existing PR..."
  gh pr edit "$bookmark" --body "$description"
else
  echo "Creating new draft PR..."
  gh pr create --draft --head "$bookmark" --body "$description"
fi
""",
]
sync = ["git", "fetch", "--all-remotes"]
stack = ["log", "-r", "stack()"]
c = ["commit"]
ci = ["commit", "--interactive"]
e = ["edit"]
s = ["status"]
parents = ["log", "-r", "parents(@)"]
merge = [
	"util",
	"exec",
	"--",
	"sh",
	"-c",
	"jj new @ \"$1\" -m \"Merge $1\"",
	"",
]
gi = ["git", "init"]
z = ["fuzzy_bookmark"]
za = ["bookmark", "list", "-a"]

fuzzy_bookmark = [
	"util",
	"exec",
	"--",
	"sh",
	"-c",
	"""
if [ "x$1" = "x" ]; then
  jj bookmark list
else
  jj bookmark list -a -T 'separate("@", name, remote) ++ "\n"' 2> /dev/null | sort | uniq | fzf -f "$1" | head -n1 | xargs jj new
fi
""",
	"",
]

[remotes.origin]
auto-track-bookmarks = "glob:*"

[fsmonitor]
# Use Watchman for faster working copy snapshots in large repos
# Requires: brew install watchman
backend = "watchman"

[git]
write-change-id-header = true
sign-on-push = true
abandon-unreachable-commits = true
track-default-bookmark-on-clone = true
private-commits = "description(glob:'wip:*') | description(glob:'private:*')"

[revset-aliases]
"closest_bookmark(to)" = "heads(::to & bookmarks())"
"fork_history(to, from)" = "fork_point(to | from)..@"
"immutable_heads()" = "builtin_immutable_heads() | remote_bookmarks()"
"closest_pushable(to)" = 'heads(::to & mutable() & ~description(exact:"") & (~empty() | merges()))'
# stack(x, n) is the set of mutable commits reachable from 'x', with 'n'
# parents. 'n' is often useful to customize the display and return set for
# certain operations. 'x' can be used to target the set of 'roots' to traverse,
# e.g. @ is the current stack.
"stack()" = 'ancestors(reachable(@, mutable()))'
"stack(x)" = 'ancestors(reachable(x, mutable()))'
"stack(x, n)" = 'ancestors(reachable(x, mutable()), n)'

[template-aliases]
"format_timestamp(timestamp)" = "timestamp.ago()"
'format_short_change_id(id)' = 'id.shortest()'

[templates]
draft_commit_description = '''
  concat(
    coalesce(description, default_commit_description, "\n"),
    surround(
      "\nJJ: This commit contains the following changes:\n", "",
      indent("JJ:     ", diff.stat(72)),
    ),
    "\nJJ: ignore-rest\n",
    diff.git(),
  )
'''
# log_node = '''
# if(self && !current_working_copy && !immutable && !conflict && in_branch(self),
#   "â—‡",
#   builtin_log_node
# )
# '''


# Work configuration - conditional on repository location
[[--scope]]
--when.repositories = ["~/Code/work"]
[--scope.user]
email = "laurynas@fiberplane.com"


[lazyjj]
diff-tool = "difft"

[gg.ui]
recent-workspaces = ["/Users/laurynas-fp/Code/work/nocturne", "/Users/laurynas-fp/Code/laulauland/jj-agent"]
